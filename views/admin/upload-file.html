<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="/public/assets/himatipolnes.jpg"
    />
    <title>Upload CSV User | HIMA TI e-Election</title>
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Quicksand:wght@300..700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/public/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/public/css/page.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/public/css/admin-crud.css" />
    <link rel="stylesheet" href="/public/css/admin.css" />
    <link rel="stylesheet" href="/public/css/admin-navbar.css" />
    <link rel="stylesheet" href="/public/css/toast.css" />
  </head>

  <body>
    <!-- Navbar akan di-load otomatis -->

    <!-- Container -->
    <div class="container py-4">
      <div class="row g-4 justify-content-center">
        <div class="col-md-8">
          <!-- Title Card -->
          <header class="title-card">
            <h1><i class="bi bi-upload me-1"></i>Upload Data Pemilih</h1>
            <!-- <p class="text-muted">HIMA TI e-Election System</p> -->
          </header>

          <!-- Upload Card -->
          <div class="generate-card shadow-sm">
            <div class="card-body">
              <h4 class="card-title mb-3">
                <i class="bi bi-upload me-1"></i>Upload CSV Data
              </h4>
              <p>
                Silakan upload data pemilih dalam format file:
                <strong>.csv</strong>
                <i class="bi bi-filetype-csv"></i>
              </p>

              <!-- Penjelasan format CSV -->
              <div class="alert alert-info">
                <h5>
                  <i class="bi bi-file-earmark-text-fill"></i> Format CSV yang
                  Diperlukan
                </h5>
                <p>Urutan kolom wajib sebagai berikut:</p>
                <pre><code>NIM,Full Name,Study Program,Phone Number</code></pre>
                <ul>
                  <li>
                    <strong>NIM</strong>: Nomor Induk Mahasiswa (contoh:
                    210411100001)
                  </li>
                  <li><strong>Full Name</strong>: Nama lengkap mahasiswa</li>
                  <li><strong>Study Program</strong>: Nama program studi</li>
                  <li><strong>Phone Number</strong>: Nomor HP aktif</li>
                </ul>
                <p><strong>Contoh isi file CSV:</strong></p>
                <pre>
210411100001,Andi Saputra,Teknik Informatika,081234567890
210411100002,Budi Santoso,Sistem Informasi,081298765432
                </pre>
              </div>

              <!-- Upload Form -->
              <form
                id="csvUploadForm"
                class="upload-section"
                enctype="multipart/form-data"
              >
                <div class="mb-3">
                  <label for="csvFile" class="form-label"
                    ><i class="bi bi-upload me-1"></i>Pilih File CSV:</label
                  >
                  <input
                    type="file"
                    class="form-control"
                    id="csvFile"
                    accept=".csv"
                    required
                  />
                </div>
                <div class="text-center">
                  <button type="submit" class="btn btn-primary">
                    Upload <i class="bi bi-upload"></i>
                  </button>
                </div>
              </form>

              <!-- Result Box -->
              <div class="mt-4">
                <label for="result" class="form-label"
                  ><i class="bi bi-code-slash me-1"></i>Hasil:</label
                >
                <pre
                  id="result"
                  class="bg-light p-3 border rounded"
                  style="max-height: 300px; overflow: auto"
                ></pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <div id="confirm-toast" class="toast confirm hidden">
      <span id="confirm-message">Apakah kamu yakin ingin logout?</span>
      <div class="buttons">
        <button id="confirm-yes">Ya</button>
        <button id="confirm-no">Tidak</button>
      </div>
    </div>

    <!-- Upload CSV Script -->
    <script>
      document
        .getElementById("csvUploadForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const fileInput = document.getElementById("csvFile");
          const file = fileInput.files[0];
          const resultBox = document.getElementById("result");

          if (!file) {
            showToast("Harap pilih file CSV!", "error");
            resultBox.textContent = "";
            return;
          }

          const formData = new FormData();
          formData.append("file", file);

          resultBox.textContent = "⏳ Mengupload...";

          try {
            const response = await fetch(
              "https://api-hima-ti-e-election.sgp.dom.my.id/api/users/bulk",
              {
                method: "POST",
                body: formData,
                credentials: "include",
              }
            );

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error.message || "Upload gagal");
              showToast("Upload gagal: " + data.error.message, "error");
            }

            let message = `✅ Upload berhasil: user berhasil diinput.\n`;
            if (data.error_rows?.length) {
              message += `❌ Baris gagal: ${
                data.error_rows.length
              }\n\n${JSON.stringify(data.error_rows, null, 2)}`;
            }

            showToast("Upload berhasil!", "success");
            resultBox.textContent = message;
          } catch (error) {
            resultBox.textContent = `🚨 Error: ${error.message}`;
            showToast("Gagal upload file: " + error.message, "error");
          }
        });

      function showToast(message, type = "success") {
        // If toast is locked, don't show new toasts
        if (window._toastLocked) return;

        const toast = document.getElementById("toast");
        if (!toast) return;

        toast.className = `toast ${type} show`;
        toast.textContent = message;

        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }
    </script>

    <!-- Bootstrap Script -->
    <script src="/public/js/bootstrap.bundle.min.js"></script>

    <!-- Custom Scripts -->

    <!-- Optional Scripts -->
    <script type="module" src="/public/js/design_app.js"></script>
    <script type="module" src="/public/js/auth_app.js"></script>
  </body>
</html>
