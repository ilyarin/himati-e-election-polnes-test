<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="/public/assets/himatipolnes.jpg"
    />
    <title>Generate & Send Password | HIMA TI e-Election</title>
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Quicksand:wght@300..700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/public/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/public/css/page.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/public/css/admin.css" />
    <link rel="stylesheet" href="/public/css/admin-navbar.css" />
    <link rel="stylesheet" href="/public/css/toast.css" />
  </head>
  <body>
    <!-- Navbar akan di-load otomatis -->

    <div class="container py-4">
      <div class="row g-4 justify-content-center">
        <div class="col-md-6">
          <!-- Title Card -->
          <header class="title-card">
            <h1><i class="bi bi-key me-1"></i>Generate & Send Password</h1>
          </header>

          <!-- Generate Section -->
          <div class="generate-card">
            <h4>
              <i><i class="bi bi-key me-2"></i></i>Generate Password Mahasiswa
              Pemilih
            </h4>
            <p>
              Klik tombol di bawah untuk membuat password acak untuk semua
              pemilih.
            </p>
            <button id="generatePassword" class="btn btn-warning w-100 mb-3">
              <i class="bi bi-key me-2"></i>Generate Password & Send WhatsApp
            </button>

            <div class="result-section">
              <p class="result-label">
                <i class="bi bi-info-circle me-1"></i>Hasil:
              </p>
              <div id="resultBox" class="result-box"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <div id="confirm-toast" class="toast confirm hidden">
      <span id="confirm-message">Apakah kamu yakin ingin logout?</span>
      <div class="buttons">
        <button id="confirm-yes">Ya</button>
        <button id="confirm-no">Tidak</button>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document
        .getElementById("generatePassword")
        .addEventListener("click", async () => {
          const btn = document.getElementById("generatePassword");
          const resultBox = document.getElementById("resultBox");

          // Disable tombol dan reset UI
          btn.disabled = true;
          btn.innerHTML =
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Mengirim...';
          resultBox.textContent = "";
          resultBox.style.color = "black";

          try {
            const API_URL =
              "https://api-hima-ti-e-election.sgp.dom.my.id/api/users/generate-passwords";

            const response = await fetch(API_URL, {
              method: "POST",
              credentials: "include",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({}),
            });

            const data = await response.json();

            if (!response.ok) {
              // Tangani error status HTTP spesifik
              let errorMsg = "";
              if (response.status === 401) {
                errorMsg = "Tidak diizinkan (401 Unauthorized)";
              } else if (response.status === 403) {
                errorMsg = "Akses dibatasi (403 Forbidden)";
              } else if (response.status === 500) {
                errorMsg = "Kesalahan server (500)";
              } else {
                errorMsg = data.error?.message || "Terjadi kesalahan.";
              }
              throw new Error(errorMsg);
            }

            if (data.error) {
              throw new Error(
                "Tidak Ada User Yang Terdaftar Atau Yang Passwordnya Kosong"
              );
            }

            // Jika sukses, tampilkan pesan dan list
            resultBox.style.color = "green";
            const successMessage =
              data.message || "Password berhasil dikirim ke WhatsApp.";
            resultBox.textContent = `âœ… ${successMessage}`;

            // PANGGIL SHOWTOAST UNTUK SUCCESS
            showToast("Password berhasil dikirim ke WhatsApp", "success");
          } catch (error) {
            resultBox.style.color = "red";
            const errorMessage = `Error: ${error.message}`;
            resultBox.textContent = `ðŸš¨ ${errorMessage}`;

            // PANGGIL SHOWTOAST UNTUK ERROR
            showToast("Terjadi kesalahan: " + error.message, "error");
          } finally {
            btn.disabled = false;
            btn.innerHTML =
              '<i class="bi bi-key me-2"></i>Generate Password & Send WhatsApp';
          }
        });

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.className = `toast show ${type}`;
        toast.textContent = message;

        setTimeout(() => {
          toast.className = "toast";
        }, 4000);
      }
    </script>
    <script type="module" src="/public/js/auth_app.js"></script>
    <script type="module" src="/public/js/design_app.js"></script>
  </body>
</html>
